<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<th:block th:replace="~{/layout/basic :: setContent(~{this::content})}">
<th:block th:fragment="content">
  <style>
  .uploadResult {
        width:100%;
        background-color: gray;
        margin-top:10px;
  }
  .uploadResult ul {
        display: flex;
        flex-flow: row;
        justify-content: center;
        align-items: center;
        vertical-align: top;
        overflow: auto;
  }
  .uploadResult ul li {
        list-style: none;
        padding: 10ox;
        margin-left: 2em;
  }

  .uploadResult ul li img {
        width:100px;
  }

  .card-title a {
    text-decoration : none;
    color: #FFD119;
  }
</style>

  <div>
<!-- header -->
    <div>
      <div class="content-header">
        <div class="background-img-blur">
          <img th:src="|/display?fileName=${dto.imageDTOList[0].getImageURL()}|">
        </div>

        <div class="thumbnail-wrap">
          <img th:src="|/display?fileName=${dto.imageDTOList[0].getThumbnailURL()}|">
        </div>
      </div>

      <div class="content-body">
aa
      </div>
    </div>

<!--  info  -->
    <div>
<br><br><br><br><br><br><br><br><br><br><br><br>
      <br><br><br><br><br><br><br><br><br><br>
    </div>
  </div>

    <input type="hidden" class="form-control" name="pno" th:value="${dto.pno}" readonly>

  <div class="form-group">
    <label>제목</label>
    <input type="text" class="form-control" name="title" th:value="${dto.title}" readonly>
  </div>

<!--  <div class="form-group">-->
<!--    <label></label>-->
<!--    <input type="text" class="form-control" name="reviewCnt" th:value="${dto.reviewCnt}" readonly>-->
<!--  </div>-->

  <div class="form-group">
    <label>평균</label>
    <input type="text" class="form-control" name="avg" th:value="${dto.avg}" readonly>
  </div>

  <div class="uploadResult">
    <ul>
      <li th:each="paintingImage: ${dto.imageDTOList}" th:data-file="${paintingImage.getThumbnailURL()}">
        <img th:if="${paintingImage.path != null}" th:src="|/display?fileName=${paintingImage.getThumbnailURL()}|">
      </li>
    </ul>
  </div>

  <button type="button" class="btn btn-primary">
    Review Count <span class="badge badge-light">[[${dto.reviewCnt}]]</span>
  </button>

  <button type="button" class="btn btn-info addReviewBtn">
    Review Register
  </button>

  <div class="list-group reviewList">

  </div>

  <div class="reviewModal modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Review</h5>

          <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close">
          </button>
        </div>

        <div class="modal-body">
          <div class="form-group">
            <label>Review ID</label>
            <input type="text" class="form-control" name="id">
          </div>

          <div class="form-group">
            <label>Grade<span class="grade"></span></label>
            <div class="starrr"></div>
          </div>

          <div class="form-group">
            <label>Review Text</label>
            <input type="text" class="form-control" name="text" placeholder="awesome!!!!">
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary reviewSaveBtn">Save changes</button>
          <button type="button" class="btn btn-warning modifyBtn">Modify</button>
          <button type="button" class="btn btn-danger removeBtn">Remove</button>
        </div>
      </div>
    </div>
  </div>

  <div class="imageModal modal" tabindex="-2" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Picture</h5>

          <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.js"
          integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
          crossorigin="anonymous"></script>
  <script th:src="@{/js/starrr.js}"></script>
  <link th:href="@{/css/starrr.css}" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.css"/>
  <script>
    $(document).ready(function(e){
      let grade = 0;
      let pno = [[${dto.pno}]];

      $('.starrr').starrr({
        rating: grade,
        change: function(e, value){
          if(value){
            //console.log(value);
            grade = value;
          }
        }
      });

      //$(".reviewModal").modal("show");

      let reviewModal = $(".reviewModal");
      let inputMid = $('input[name="id"]');
      let inputText = $('input[name="text"]');

      $(".addReviewBtn").click(function(){
        inputMid.val("");
        inputText.val("");

        $(".removeBtn, .modifyBtn").hide();
        $(".reviewSaveBtn").show();

        reviewModal.modal('show');

      });

      $('.reviewSaveBtn').click(function(){
        let data = {pno:pno, grade:grade, text:inputText.val(), id:inputMid.val()};
        console.log(data);

        $.ajax({
          url:'/reviews/'+pno,
          type:'POST',
          data:JSON.stringify(data),
          contentType:"application/json; charset=utf-8",
          dataType:"text",
          success: function(result){
            console.log("result: "+result);
            self.location.reload();
          }
        })
        reviewModal.modal('hide');
      });

      function getPaintingReviews() {
        function formatTime(str){
          let date = new Date(str);

          return date.getFullYear() + '/' + (date.getMonth() + 1) + '/' + date.getDate() + ' ' +
          date.getHours() + ':' + date.getMinutes();
        }

        $.getJSON("/reviews/"+pno+"/all", function(arr){
          let str = "";

          $.each(arr, function(idx, review) {
            console.log(review);

            str += '<div class="card-body" data-reviewnum='+review.reviewnum+' data-id='+review.id+'>';
            str += '<h5 class="card-title">'+review.name+' <span><a href="#" class="fa fa-star"></a>'+review.grade+'</span></h5>';
            str += '<h6 class="card-subtitle mb-2 text-muted">'+review.text+'</h6>';
            str += '<p class="card-text">'+formatTime(review.regDate)+'</p>';
            str += '</div>';
          });
          $(".reviewList").html(str);
        });
      }
      getPaintingReviews();


      let reviewnum;

      $(".reviewList").on("click", ".card-body", function(){
        $(".reviewSaveBtn").hide();
        $(".removeBtn , .modifyBtn").show();

        let targetReview = $(this);

        reviewnum = targetReview.data("reviewnum");
        console.log("reviewnum: "+reviewnum);
        inputMid.val(targetReview.data("id"));
        //inputText.val(targetReview.find('.card-title').clone().children().remove().end().text());
        inputText.val(targetReview.find('.card-subtitle').text());

        let grade = targetReview.find('.card-title span').text();
        $(".starrr a:nth-child("+grade+")").trigger('click');

        $('.reviewModal').modal('show');
      });

      $(".modifyBtn").on("click", function(){
        let data = {reviewnum: reviewnum, pno:pno, grade:grade, text:inputText.val(), id: inputMid.val()};
        console.log(data);

        $.ajax({
          url:'/reviews/'+pno+"/"+reviewnum,
          type:"PUT",
          data:JSON.stringify(data),
          contentType:"application/json; charset=utf-8",
          dataType:"text",
          success:function(result){
            console.log("result"+result);
            self.location.reload();
          }
        })
        reviewModal.modal('hide');
      });

      $(".removeBtn").on("click",function(){
        let data = {reviewnum: reviewnum};
        console.log(data);

        $.ajax({
          url:'/reviews/'+pno+'/'+reviewnum,
          type:'DELETE',
          contentType:"application/json; charset=utf-8",
          dataType:"text",
          success: function(result){
            //console.log("result: " + result);
            self.location.reload();
          }
        })
      reviewModal.modal('hide');
    });

    $(".uploadResult li").click(function(){
      let file = $(this).data('file');
      //console.log(file);
      $('.imageModal .modal-body').html("<img style='width:100%' src='/display?fileName="+file+"&size=1'>");
      $(".imageModal").modal("show");
    });
  });
  </script>
</th:block>
</th:block>
</html>